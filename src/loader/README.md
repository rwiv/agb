# Resource Loader 모듈

이 모듈은 파일 시스템에서 플러그인 구조를 스캔하고, 분산된 파일들을 읽어 `Resource` 객체로 로드하는 핵심 로직을 담당합니다.

## 핵심 역할

1.  **플러그인 스캔**: 소스 디렉터리를 재귀적으로 탐색하여 유효한 파일 목록을 수집합니다.
2.  **파일 필터링**: 설정된 제외 패턴과 보안 규칙에 따라 불필요하거나 금지된 파일을 걸러냅니다.
3.  **리소스 그룹화**: 파일 이름과 경로 구조를 분석하여 흩어져 있는 Markdown 본문과 메타데이터 파일을 하나의 리소스로 결합합니다.
4.  **메타데이터 파싱**: YAML, YML 형식의 메타데이터를 통합된 데이터 모델로 변환합니다.

## 주요 구성 요소

### 1. ResourceLoader 및 모듈 인터페이스 (`mod.rs`)
모듈의 엔트리포인트로, 스캔(`FileFilter`), 해석(`ResourcePathResolver`), 조립(`ResourceParser`) 단계를 오케스트레이션합니다.
- **`ResourceLoader` (Public API)**: 플러그인 디렉터리를 탐색하고 실제 리소스 객체를 조립하는 핵심 객체입니다.
    - `new()`: 새로운 로더 인스턴스 생성.
    - `load()`: 모든 유효한 리소스를 로드하여 반환.

## 설계 이점
`loader` 모듈은 파일 시스템에서 리소스를 읽어오는 기술적인 메커니즘에 집중하며, 어떤 리소스를 선택하여 사용할지에 대한 정책(예: 특정 식별자 필터링)은 `app` 모듈에서 담당하도록 책임을 분리하였습니다.

### 2. FileFilter (`filter.rs`)
스캔 과정에서 파일의 유효성을 검증합니다.
- **제외 패턴**: `agb.yaml`의 `exclude` 필드에 정의된 Glob 패턴 지원.
- **숨김 파일 무시**: `.`으로 시작하는 파일 및 디렉터리 제외.
- **보안 검증 (PRD 제약)**: 플러그인 내부에 타겟 에이전트 전용 메인 파일(`GEMINI.md`, `CLAUDE.md`, `OPENCODE.md`)이 존재할 경우 빌드 에러를 발생시킵니다.

### 3. ResourcePathResolver (`resolver.rs`)
파일 경로를 분석하여 리소스 단위(`ScannedResource`)로 그룹화합니다.
- **Commands & Agents**: `[plugin]/[type]/[name].{md,yaml,yml}` 구조를 `ScannedPaths::Command` 또는 `Agent`로 분석합니다.
- **Skills**: `[plugin]/skills/[skill_name]/` 폴더 내의 파일들을 그룹화하여 `ScannedPaths::Skill` 구조로 반환합니다. `SKILL.{yaml,yml}`을 선택적 메타데이터로 인식하며, 그 외의 다른 모든 파일들은 `extras` 필드에 수집됩니다.
- **포맷 충돌 검증**: 동일 리소스에 대해 YAML과 YML 메타데이터가 공존할 경우 에러를 발생시켜 일관성을 유지합니다.

### 4. ResourceParser (`parser.rs`)
`ScannedResource` 정보를 기반으로 메타데이터 파싱과 최종 `Resource` 객체 조립을 담당합니다.
- **메타데이터 파싱**: YAML, YML 형식을 `serde_json::Value`로 변환.
- **메타데이터 병합**: 타겟 에이전트 규격에 맞춰 본문(Frontmatter)과 외부 메타데이터를 병합합니다 (`merge_metadata`).
    - **검증 규칙**: 모든 공용 메타데이터는 마크다운 Frontmatter에 위치해야 하며, 외부 YAML 파일은 타겟 에이전트 예약어 섹션만 포함할 수 있습니다. 일반 필드가 외부 파일에서 발견되면 빌드 오류가 발생합니다.
- **리소스 조립**: 마크다운 본문, 병합된 메타데이터, 그리고 `Skill`의 경우 수집된 `extras` 파일 정보를 결합하여 `Resource` 타입별 객체 생성.

### 5. Registry (`registry.rs`)
로드된 `Resource` 객체들을 메모리에 보관하고 관리하는 중앙 저장소 역할을 합니다.
- **리소스 등록**: 빌드 대상으로 선택된 리소스들을 레지스트리에 등록합니다.
- **충돌 검증**: 동일한 리소스 타입(Command, Agent, Skill)과 이름을 가진 리소스가 여러 플러그인에서 중복으로 등록되지 않도록 사전에 방지하여 빌드의 안정성을 보장합니다.

## 리소스 그룹화 규칙

| 리소스 타입 | 구조 | 메타데이터 매칭 | 본문 매칭 | 추가 파일 |
| :--- | :--- | :--- | :--- | :--- |
| **Commands/Agents** | 파일 기반 | 파일 이름이 동일한 YAML/YML | 파일 이름이 동일한 `.md` | 지원하지 않음 |
| **Skills** | 폴더 기반 | `SKILL.yaml/yml` | 폴더 내의 `.md` 파일 | 폴더 내의 기타 모든 파일 (계층 구조 유지) |

## 구현 상세

- **중복 검증**: 동일한 리소스 이름에 대해 여러 메타데이터 형식이 발견되면 즉시 빌드를 중단하여 설정의 모호함을 방지합니다.
- **확장성**: `MetadataParser`를 통해 새로운 설정 포맷을 쉽게 추가할 수 있는 구조입니다.
